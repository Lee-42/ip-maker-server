# 数据库初始化与管理

本文档详细说明了 meme-server 项目的数据库初始化机制、手动导入方法以及日常管理操作。

## 1. 自动初始化机制

本项目利用了 Docker 官方 MySQL 镜像的特性，实现了数据库的自动初始化。

### 原理
在 `docker-compose.dev.yml` 中，我们将本地的初始化脚本目录挂载到了容器的特定路径：

```yaml
volumes:
  - ./storage/init:/docker-entrypoint-initdb.d
```

- **挂载源**: `/root/projects/meme-server/server/storage/init`
- **目标路径**: `/docker-entrypoint-initdb.d`
- **行为**: 当 MySQL 容器**首次启动**且数据目录为空时，它会自动执行 `/docker-entrypoint-initdb.d` 目录下所有扩展名为 `.sql`, `.sh` 的文件。

### 包含的脚本
- `hotgo.sql`: 包含了 HotGo 框架运行所需的所有基础表结构和初始数据（如默认管理员账号、菜单配置等）。

因此，当你第一次运行 `docker-compose up` 时，数据库已经自动准备就绪，**通常不需要手动干预**。

---

## 2. 手动导入数据库

如果自动初始化失败，或者你需要重置数据库，可以通过以下方式手动导入 SQL 文件。

### 前置条件
确保 MySQL 容器正在运行：
```bash
docker ps --filter "name=meme-mysql"
```

### 导入命令
使用 `docker exec` 将 SQL 文件内容传输给容器内的 MySQL 客户端：

```bash
cat /root/projects/meme-server/server/storage/init/hotgo.sql | docker exec -i meme-mysql mysql -u leo -pjmqs18666 meme
```

- `-u leo`: 用户名
- `-p...`: 密码 (注意 `-p` 和密码之间没有空格)
- `meme`: 目标数据库名

### 常见问题
如果在数据库已存在的情况下再次导入，可能会遇到 **Duplicate entry** 错误：
```text
ERROR 1062 (23000) at line 73: Duplicate entry '1' for key 'hg_addon_hgexample_table.PRIMARY'
```
这说明数据已经存在，导入被中断。这是正常现象，除非你需要强制覆盖数据。

---

## 3. 常用管理命令

### 查看所有表
```bash
docker exec -i meme-mysql mysql -u leo -pjmqs18666 meme -e "SHOW TABLES;"
```

### 进入 MySQL 命令行
```bash
docker exec -it meme-mysql mysql -u leo -pjmqs18666 meme
```

### 清空/重置数据库
**⚠️ 警告：此操作将删除所有数据！**

如果你需要彻底重置数据库，可以删除 Docker Volume 并重启容器：

```bash
# 1. 停止并删除容器
docker-compose -f docker-compose.dev.yml down

# 2. 删除数据库卷 (注意卷名可能因项目名而异，可用 docker volume ls 查看)
docker volume rm meme-server_mysql_data

# 3. 重新启动 (会触发自动初始化)
docker-compose -f docker-compose.dev.yml up -d
```
